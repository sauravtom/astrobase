<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vedic Astrology Mini App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="app" class="flex items-center justify-center min-h-screen">

        <!-- Stage 1: Form -->
        <div id="form-stage" class="w-full max-w-md p-8 space-y-6 bg-gray-800 rounded-lg shadow-lg">
            <div>
                <h2 class="text-3xl font-bold text-center text-purple-400">Vedic Astrology Chart</h2>
                <p class="mt-2 text-center text-gray-400">Enter your birth details to begin.</p>
            </div>
            <form id="birth-form" class="space-y-6">
                <div>
                    <label for="date" class="block text-sm font-medium text-gray-300">Date of Birth</label>
                    <input type="date" id="date" name="date" required class="w-full px-3 py-2 mt-1 text-gray-200 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label for="time" class="block text-sm font-medium text-gray-300">Time of Birth</label>
                    <input type="time" id="time" name="time" required class="w-full px-3 py-2 mt-1 text-gray-200 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="relative">
                    <label for="place" class="block text-sm font-medium text-gray-300">Place of Birth</label>
                    <input type="text" id="place" name="place" placeholder="e.g., New York, USA" required autocomplete="off" class="w-full px-3 py-2 mt-1 text-gray-200 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <div id="place-suggestions" class="absolute z-10 w-full mt-1 bg-gray-700 border border-gray-600 rounded-md shadow-lg hidden"></div>
                </div>
                <div>
                    <button type="submit" id="generate-btn" class="w-full px-4 py-2 font-bold text-white bg-purple-600 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 focus:ring-offset-gray-800">
                        Generate My Chart
                    </button>
                </div>
            </form>
            <p id="form-error" class="text-sm text-center text-red-400"></p>
        </div>

        <!-- Stage 2: Chat -->
        <div id="chat-stage" class="hidden w-full max-w-2xl h-[80vh] flex flex-col bg-gray-800 rounded-lg shadow-lg">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-xl font-bold text-purple-400">Your Astrological Chat</h2>
                <button id="claim-nft-btn" class="px-4 py-2 text-sm font-bold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-gray-800">
                    Claim Astrobase NFT
                </button>
            </div>
            <div id="chat-history" class="flex-1 p-6 space-y-4 overflow-y-auto">
                <!-- Messages will be appended here -->
            </div>
            <div class="p-4 border-t border-gray-700">
                <form id="chat-form" class="flex items-center space-x-4">
                    <input type="text" id="chat-input" placeholder="Ask a question about your chart..." class="flex-1 px-4 py-2 text-gray-200 bg-gray-700 border border-gray-600 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button type="submit" id="send-btn" class="px-6 py-2 font-bold text-white bg-purple-600 rounded-full hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 focus:ring-offset-gray-800">
                        Send
                    </button>
                </form>
            </div>
        </div>

    </div>

    <!-- NFT Minting Modal -->
    <div id="nft-modal" class="fixed inset-0 z-50 items-center justify-center hidden bg-black bg-opacity-75">
        <div class="w-full max-w-sm p-6 bg-gray-800 rounded-lg shadow-xl">
            <div class="flex items-center justify-between">
                <h3 class="text-2xl font-bold text-purple-400">Mint Your Astrobase NFT</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="mt-6 text-center">
                <div class="w-48 h-48 mx-auto bg-gray-700 rounded-lg flex items-center justify-center">
                    <svg class="w-24 h-24 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M4 17v4M2 19h4M17 3v4M16 5h4M18 17v4M17 19h4M12 9a3 3 0 100-6 3 3 0 000 6zM7 21v-4a5 5 0 015-5h0a5 5 0 015 5v4"></path></svg>
                </div>
                <p class="mt-4 text-lg">Your Astrological Sign:</p>
                <p id="astro-sign" class="text-2xl font-bold text-yellow-400"></p>
                <button id="mint-nft-btn" class="w-full px-4 py-3 mt-6 font-bold text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 focus:ring-offset-gray-800">
                    Mint My NFT
                </button>
            </div>
        </div>
    </div>


    <script>
        const formStage = document.getElementById('form-stage');
        const chatStage = document.getElementById('chat-stage');
        const birthForm = document.getElementById('birth-form');
        const generateBtn = document.getElementById('generate-btn');
        const formError = document.getElementById('form-error');
        const placeInput = document.getElementById('place');
        const placeSuggestions = document.getElementById('place-suggestions');

        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatHistory = document.getElementById('chat-history');

        const claimNftBtn = document.getElementById('claim-nft-btn');
        const nftModal = document.getElementById('nft-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const mintNftBtn = document.getElementById('mint-nft-btn');
        const astroSignEl = document.getElementById('astro-sign');

        let planetaryPositions = null;

        // --- Place Autocomplete --- 
        placeInput.addEventListener('input', async () => {
            const query = placeInput.value;
            if (query.length < 2) {
                placeSuggestions.innerHTML = '';
                placeSuggestions.classList.add('hidden');
                return;
            }

            // NOTE: Replace 'demo' with your own free GeoNames username for production use.
            const url = `https://secure.geonames.org/searchJSON?q=${encodeURIComponent(query)}&maxRows=5&username=demo`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                placeSuggestions.innerHTML = '';

                if (data.geonames && data.geonames.length > 0) {
                    data.geonames.forEach(place => {
                        const suggestionDiv = document.createElement('div');
                        suggestionDiv.className = 'p-2 cursor-pointer hover:bg-gray-600';
                        const placeName = `${place.name}, ${place.adminName1 || ''}, ${place.countryName}`.replace(/, ,/g, ', ').trim();
                        suggestionDiv.textContent = placeName;
                        suggestionDiv.addEventListener('click', () => {
                            placeInput.value = placeName;
                            placeSuggestions.innerHTML = '';
                            placeSuggestions.classList.add('hidden');
                        });
                        placeSuggestions.appendChild(suggestionDiv);
                    });
                    placeSuggestions.classList.remove('hidden');
                } else {
                    placeSuggestions.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error fetching place suggestions:', error);
                placeSuggestions.classList.add('hidden');
            }
        });

        document.addEventListener('click', (e) => {
            if (!placeInput.contains(e.target)) {
                placeSuggestions.classList.add('hidden');
            }
        });

        // --- Stage 1: Form Logic ---
        birthForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            formError.textContent = '';
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';

            const data = {
                date: document.getElementById('date').value,
                time: document.getElementById('time').value,
                place: placeInput.value,
            };

            try {
                const response = await fetch('/api/generate-chart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Failed to generate chart.');
                }

                planetaryPositions = await response.json();
                
                // Transition to chat
                formStage.classList.add('hidden');
                chatStage.classList.remove('hidden');
                chatStage.classList.add('flex');
                addMessage('assistant', 'Your chart is ready. Feel free to ask me anything about your destiny.');

            } catch (error) {
                formError.textContent = `Error: ${error.message}`;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate My Chart';
            }
        });

        // --- Stage 2: Chat Logic ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userQuestion = chatInput.value.trim();
            if (!userQuestion) return;

            addMessage('user', userQuestion);
            chatInput.value = '';
            showTypingIndicator();

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ planetaryPositions, userQuestion }),
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Failed to get a response.');
                }

                const { answer } = await response.json();
                removeTypingIndicator();
                addMessage('assistant', answer);

            } catch (error) {
                removeTypingIndicator();
                addMessage('assistant', `Sorry, an error occurred: ${error.message}`);
            }
        });

        // --- NFT Modal Logic ---
        claimNftBtn.addEventListener('click', () => {
            if (planetaryPositions && planetaryPositions.sun) {
                astroSignEl.textContent = planetaryPositions.sun.sign;
            }
            nftModal.classList.remove('hidden');
            nftModal.classList.add('flex');
        });

        closeModalBtn.addEventListener('click', () => {
            nftModal.classList.add('hidden');
            nftModal.classList.remove('flex');
        });

        mintNftBtn.addEventListener('click', () => {
            alert('Congratulations! Your unique Astrobase NFT has been minted.');
            nftModal.classList.add('hidden');
            nftModal.classList.remove('flex');
        });

        function addMessage(sender, text) {
            const messageElement = document.createElement('div');
            const alignment = sender === 'user' ? 'justify-end' : 'justify-start';
            const bgColor = sender === 'user' ? 'bg-purple-600' : 'bg-gray-700';
            
            messageElement.className = `flex ${alignment}`;
            messageElement.innerHTML = `<div class="max-w-xs md:max-w-md lg:max-w-lg px-4 py-2 rounded-lg ${bgColor}">${text}</div>`;
            chatHistory.appendChild(messageElement);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function showTypingIndicator() {
            const typingElement = document.createElement('div');
            typingElement.id = 'typing-indicator';
            typingElement.className = 'flex justify-start';
            typingElement.innerHTML = `<div class="max-w-xs px-4 py-2 rounded-lg bg-gray-700"><em>Typing...</em></div>`;
            chatHistory.appendChild(typingElement);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

    </script>

</body>
</html>